name: Build & Deploy site

on:
  workflow_dispatch:

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
      - name: Checkout precizer.github.io repo
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Prepare Jekyll source (site-src) from this repo + precizer READMEs
        run: |
          set -euo pipefail

          rm -rf site-src public

          # Copy EVERYTHING from the current repo into site-src (including _config.yml),
          # excluding service directories.
          rsync -a \
            --exclude ".git/" \
            --exclude ".github/" \
            --exclude "site-src/" \
            --exclude "public/" \
            ./ site-src/

      - name: Checkout precizer sources
        uses: actions/checkout@v4
        with:
          repository: precizer/precizer
          ref: main
          path: precizer

      - name: Create markdown pages (GitHub-compatible links)
        run: |
          set -euo pipefail

          # Just in case, remove any old files
          rm -f site-src/index.md site-src/README.md site-src/README.ru.md site-src/CONTRIBUTING.md site-src/CONTRIBUTING.ru.md site-src/TESTING.md site-src/TESTING.ru.md site-src/CHANGELOG.md

          # English: file is named README.md (as in the repo), but is served at /
          {
            echo '---'
            echo 'permalink: /'
            echo '---'
            cat precizer/README.md
          } > site-src/README.md

          # Russian: file is named README.ru.md (as in the repo), served at /README.ru.html
          {
            echo '---'
            echo 'permalink: /README.ru.html'
            echo '---'
            cat precizer/README.ru.md
          } > site-src/README.ru.md

          # Contributing guide: file is named CONTRIBUTING.md, served at /CONTRIBUTING.html
          {
            echo '---'
            echo 'permalink: /CONTRIBUTING.html'
            echo '---'
            cat precizer/CONTRIBUTING.md
          } > site-src/CONTRIBUTING.md

          # Russian contributing guide: file is named CONTRIBUTING.ru.md, served at /CONTRIBUTING.ru.html
          {
            echo '---'
            echo 'permalink: /CONTRIBUTING.ru.html'
            echo '---'
            cat precizer/CONTRIBUTING.ru.md
          } > site-src/CONTRIBUTING.ru.md

          # Testing guide: file is named TESTING.md, served at /TESTING.html
          {
            echo '---'
            echo 'permalink: /TESTING.html'
            echo '---'
            cat precizer/TESTING.md
          } > site-src/TESTING.md

          # Russian testing guide: file is named TESTING.ru.md, served at /TESTING.ru.html
          {
            echo '---'
            echo 'permalink: /TESTING.ru.html'
            echo '---'
            cat precizer/TESTING.ru.md
          } > site-src/TESTING.ru.md

          # Changelog: file is named CHANGELOG.md, served at /CHANGELOG.html
          {
            echo '---'
            echo 'permalink: /CHANGELOG.html'
            echo '---'
            cat precizer/CHANGELOG.md
          } > site-src/CHANGELOG.md

      - name: Build Jekyll site -> ./public
        uses: actions/jekyll-build-pages@v1
        with:
          source: site-src
          destination: public

      - name: Fix permissions for public/
        run: |
          sudo chown -R "$USER:$USER" public
          sudo chmod -R u+rwX public

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc make libpcre2-dev llvm upx gh rsync lcov libcmocka-dev

      - name: Build coverage
        working-directory: precizer
        run: |
          set -euo pipefail
          make coverage
          test -d ".builds/testitall/coverage/report"

      - name: Copy coverage + raw READMEs into public/
        run: |
          set -euo pipefail

          # coverage -> /code_coverage_report/
          mkdir -p "public/code_coverage_report"
          rsync -a --delete \
            "precizer/.builds/testitall/coverage/report/" \
            "public/code_coverage_report/"

          rsync -a \
            precizer/.html public/; ls -la public/

          # Fallback in case hidden paths are served differently
          touch public/.nojekyll

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
